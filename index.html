<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>اپ‌ساز پرو (PWA + APK)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- External libs -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    :root { --brand:#7c3aed; --bg:#0b1020; }
    .glass { backdrop-filter: saturate(1.2) blur(10px); background: linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.4)); border:1px solid rgba(0,0,0,.08) }
    .dark .glass { background: linear-gradient(180deg, rgba(20,20,26,.65), rgba(20,20,26,.4)); border-color: rgba(255,255,255,.12) }
    .neo { box-shadow: 8px 8px 20px rgba(0,0,0,.12), -8px -8px 20px rgba(255,255,255,.6); border-radius: 16px; }
    .dark .neo { box-shadow: 8px 8px 20px rgba(0,0,0,.5), -8px -8px 20px rgba(255,255,255,.03) }
    .btn { background: var(--brand); color:#fff; border-radius: 12px; padding:.7rem 1rem; transition: transform .08s ease; }
    .btn:hover { transform: translateY(-1px); }
    .btn-ghost { border:1px solid rgba(124,58,237,.4); color: var(--brand); border-radius:12px; padding:.7rem 1rem; background: transparent }
    .badge-ok { color: #16a34a; font-weight:700 }
    .badge-warn { color: #f59e0b; font-weight:700 }
    .tab { cursor: pointer; padding:.6rem 1rem; border-radius: 10px; border:1px solid transparent }
    .tab.active { border-color: rgba(124,58,237,.4); color: var(--brand); background: rgba(124,58,237,.08) }
    .code { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; }
  </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-slate-100">
  <div class="max-w-6xl mx-auto p-6">
    <!-- Header -->
    <div class="glass neo p-6 mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold">🚀 اپ‌ساز پرو (PWA فوری + APK با GitHub Actions)</h1>
        <p class="text-sm text-slate-600 dark:text-slate-300">کم‌فایل، حداکثر کارایی. فرم را پر کن، ZIP بساز، و بدون سرور APK تولید کن.</p>
      </div>
      <div class="flex items-center gap-3">
        <button id="toggleTheme" class="btn-ghost">تاریک/روشن</button>
        <span class="px-3 py-1 rounded bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300 border border-purple-300/50">نسخه پرو</span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="glass neo p-4 mb-4">
      <div class="flex gap-2">
        <div class="tab active" data-tab="basic">اطلاعات پایه</div>
        <div class="tab" data-tab="branding">تصاویر و برندینگ</div>
        <div class="tab" data-tab="advanced">گزینه‌های پیشرفته</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left: Panels -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Basic panel -->
        <div id="panel-basic" class="glass neo p-6">
          <h2 class="text-xl font-semibold mb-4">اطلاعات پایه</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label>نام اپ</label>
              <input id="appName" class="w-full border rounded p-2" value="اپ من">
            </div>
            <div>
              <label>شناسه پکیج اندروید</label>
              <input id="packageId" class="w-full border rounded p-2" value="com.example.app">
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
            <div>
              <label>آدرس سایت (start_url)</label>
              <input id="siteUrl" class="w-full border rounded p-2" value="https://example.com">
            </div>
            <div>
              <label>اسکوپ</label>
              <input id="scope" class="w-full border rounded p-2" value="/">
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
            <div>
              <label>رنگ تم</label>
              <input id="themeColor" type="color" class="w-full border rounded p-2" value="#7c3aed">
            </div>
            <div>
              <label>رنگ پس‌زمینه</label>
              <input id="bgColor" type="color" class="w-full border rounded p-2" value="#ffffff">
            </div>
            <div>
              <label>Display</label>
              <select id="display" class="w-full border rounded p-2">
                <option value="standalone">standalone</option>
                <option value="fullscreen">fullscreen</option>
                <option value="minimal-ui">minimal-ui</option>
              </select>
            </div>
          </div>
          <div class="mt-3">
            <label>توضیحات</label>
            <input id="description" class="w-full border rounded p-2" placeholder="توضیح کوتاه اپ">
          </div>
          <div class="mt-4 flex gap-3">
            <button id="buildPWA" class="btn">ساخت PWA و دانلود ZIP</button>
            <button id="prepAPK" class="btn-ghost">راهنمای ساخت APK</button>
            <button id="resetForm" class="btn-ghost">پاک‌سازی</button>
          </div>
        </div>

        <!-- Branding panel -->
        <div id="panel-branding" class="glass neo p-6 hidden">
          <h2 class="text-xl font-semibold mb-4">تصاویر و برندینگ</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label>آیکن 512×512 (PNG)</label>
              <input id="icon512" type="file" accept="image/png" class="w-full">
            </div>
            <div>
              <label>آیکن 192×192 (PNG)</label>
              <input id="icon192" type="file" accept="image/png" class="w-full">
            </div>
            <div>
              <label>اسپلش 1024×500 (PNG اختیاری)</label>
              <input id="splash" type="file" accept="image/png" class="w-full">
            </div>
          </div>
          <div class="mt-4 flex gap-3">
            <button id="genMaskable" class="btn-ghost">ساخت آیکن Maskable</button>
            <button id="auto192" class="btn-ghost">تولید 192 از 512</button>
            <button id="autoSplash" class="btn-ghost">تولید اسپلش از آیکن</button>
          </div>
        </div>

        <!-- Advanced panel -->
        <div id="panel-advanced" class="glass neo p-6 hidden">
          <h2 class="text-xl font-semibold mb-4">گزینه‌های پیشرفته</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label>Categories (کاما جدا)</label>
              <input id="categories" class="w-full border rounded p-2" placeholder="business,tools">
            </div>
            <div>
              <label>Screenshots URL (کاما جدا)</label>
              <input id="screenshots" class="w-full border rounded p-2" placeholder="https://.../shot1.png, https://.../shot2.png">
            </div>
          </div>
          <div class="mt-3">
            <label>Shortcuts</label>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
              <input id="shortcutName" class="border rounded p-2" placeholder="نام">
              <input id="shortcutUrl" class="border rounded p-2" placeholder="https://example.com/page">
              <button id="addShortcut" class="btn-ghost">افزودن</button>
            </div>
            <ul id="shortcutList" class="mt-2 text-sm"></ul>
          </div>
        </div>
      </div>

      <!-- Right: Preview & Checks & QR & Log -->
      <div class="space-y-6">
        <div class="glass neo p-6">
          <h2 class="text-xl font-semibold mb-4">پیش‌نمایش</h2>
          <div class="flex items-center gap-4">
            <canvas id="previewIcon" width="96" height="96" class="rounded-2xl border"></canvas>
            <div>
              <div id="previewName" class="text-lg font-bold">اپ من</div>
              <div id="previewDesc" class="text-slate-600 dark:text-slate-300 text-sm">توضیح اپ نمایش داده می‌شود</div>
              <div class="mt-2 flex items-center gap-2">
                <span class="text-sm">Theme</span><div id="previewTheme" class="w-6 h-6 rounded border"></div>
                <span class="text-sm">BG</span><div id="previewBg" class="w-6 h-6 rounded border"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="glass neo p-6">
          <h2 class="text-xl font-semibold mb-4">چک‌لیست PWA</h2>
          <ul class="text-sm space-y-2">
            <li>HTTPS سایت: <span id="checkHttps" class="badge-warn">نامشخص</span></li>
            <li>start_url معتبر: <span id="checkStart" class="badge-warn">نامشخص</span></li>
            <li>آیکن‌ها آماده: <span id="checkIcons" class="badge-warn">نامشخص</span></li>
            <li>رنگ‌ها تنظیم: <span id="checkColors" class="badge-warn">نامشخص</span></li>
            <li>Service Worker حاضر: <span id="checkSw" class="badge-ok">بله (تولید می‌شود)</span></li>
          </ul>
        </div>

        <div class="glass neo p-6">
          <h2 class="text-xl font-semibold mb-4">QR لینک PWA یا APK</h2>
          <div class="flex gap-2">
            <input id="qrUrl" class="flex-1 border rounded p-2" placeholder="https://yourdomain.com/pwa/index.html">
            <button id="makeQR" class="btn">ساخت QR</button>
          </div>
          <div class="mt-3 flex items-center gap-3">
            <canvas id="qrCanvas" width="160" height="160" class="rounded-lg bg-white p-2"></canvas>
            <div id="qrText" class="text-sm text-slate-600 dark:text-slate-300"></div>
          </div>
        </div>

        <div class="glass neo p-6">
          <h2 class="text-xl font-semibold mb-4">لاگ</h2>
          <div id="log" class="code bg-slate-900 text-slate-100 p-3 rounded-lg h-48 overflow-auto"></div>
        </div>
      </div>
    </div>

    <div class="mt-6 text-center text-sm text-slate-600 dark:text-slate-300">
      ZIP را روی هاست HTTPS قرار بده؛ برای APK به تب Actions برو. نسخه حرفه‌ای، کم‌فایل و بدون سرور.
    </div>
  </div>

<script>
/* Utilities */
const $ = id => document.getElementById(id);
const now = () => new Date().toLocaleTimeString('fa-IR');
const log = (msg, level='info') => {
  const prefix = level==='ok' ? '✅' : level==='warn' ? '⚠️' : level==='err' ? '❌' : '🔧';
  $('log').textContent += `[${now()}] ${prefix} ${msg}\n`;
  $('log').scrollTop = $('log').scrollHeight;
};
const isHttps = url => { try { return new URL(url).protocol === 'https:'; } catch { return false; } };
const toBlobPNG = c => new Promise(res => c.toBlob(res, 'image/png'));
const blobToCanvas = async blob => { const bmp = await createImageBitmap(blob); const c = document.createElement('canvas'); c.width=bmp.width; c.height=bmp.height; c.getContext('2d').drawImage(bmp,0,0); return c; };
const fitToCanvas = async (file, size) => {
  if (!file) return genDefaultIcon(size);
  const bmp = await createImageBitmap(file);
  const c = document.createElement('canvas'); c.width=size; c.height=size;
  const ctx = c.getContext('2d');
  const scale = Math.min(size/bmp.width, size/bmp.height);
  const w = Math.round(bmp.width*scale), h = Math.round(bmp.height*scale);
  ctx.clearRect(0,0,size,size);
  ctx.drawImage(bmp,(size-w)/2,(size-h)/2,w,h);
  return await toBlobPNG(c);
};
const genDefaultIcon = async size => {
  const c = document.createElement('canvas'); c.width=size; c.height=size;
  const ctx = c.getContext('2d');
  ctx.fillStyle = $('themeColor').value; ctx.fillRect(0,0,size,size);
  ctx.fillStyle = '#fff'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.font = `${Math.round(size*0.5)}px system-ui`;
  ctx.fillText('A', size/2, size/2);
  return await toBlobPNG(c);
};

/* Theme toggle */
$('toggleTheme').addEventListener('click', () => {
  const root = document.documentElement;
  const dark = root.classList.toggle('dark');
  localStorage.setItem('theme', dark ? 'dark' : 'light');
});
if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');

/* Tabs */
document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    const key = t.dataset.tab;
    ['basic','branding','advanced'].forEach(id => {
      $('panel-'+id).classList.toggle('hidden', id!==key);
    });
  });
});

/* Live preview */
function refreshPreview(){
  $('previewName').textContent = $('appName').value || 'App';
  $('previewDesc').textContent = $('description').value || 'توضیح اپ';
  $('previewTheme').style.background = $('themeColor').value;
  $('previewBg').style.background = $('bgColor').value;
}
['appName','description','themeColor','bgColor'].forEach(id => $(id).addEventListener('input', refreshPreview));
refreshPreview();

/* Checks */
function runChecks(){
  const httpsOk = isHttps($('siteUrl').value);
  $('checkHttps').textContent = httpsOk ? 'بله (HTTPS)' : 'خیر';
  $('checkHttps').className = httpsOk ? 'badge-ok' : 'badge-warn';
  const startOk = /^https?:\/\/.+/.test($('siteUrl').value);
  $('checkStart').textContent = startOk ? 'بله' : 'خیر';
  $('checkStart').className = startOk ? 'badge-ok' : 'badge-warn';
  const iconsOk = ($('icon192').files.length || $('icon512').files.length);
  $('checkIcons').textContent = iconsOk ? 'بله' : 'خیر (از آیکن پیش‌فرض استفاده می‌شود)';
  $('checkIcons').className = iconsOk ? 'badge-ok' : 'badge-warn';
  const colorsOk = $('themeColor').value && $('bgColor').value;
  $('checkColors').textContent = colorsOk ? 'بله' : 'خیر';
  $('checkColors').className = colorsOk ? 'badge-ok' : 'badge-warn';
  $('checkSw').textContent = 'بله (تولید می‌شود)';
  $('checkSw').className = 'badge-ok';
}
['siteUrl','icon192','icon512','themeColor','bgColor'].forEach(id => $(id).addEventListener('input', runChecks));
runChecks();

/* Shortcuts add/remove */
const S = { shortcuts: [] };
$('addShortcut').addEventListener('click', () => {
  const name = $('shortcutName').value.trim();
  const url = $('shortcutUrl').value.trim();
  if (!name || !url) { log('نام یا URL شورتکات خالی است', 'warn'); return; }
  const item = { name, short_name: name, url, icons: [] };
  S.shortcuts.push(item);
  const li = document.createElement('li');
  li.textContent = `${name} → ${url}`;
  const btn = document.createElement('button'); btn.textContent = 'حذف'; btn.className = 'btn-ghost ml-2';
  btn.onclick = () => { S.shortcuts = S.shortcuts.filter(s => s.url !== url); li.remove(); };
  li.appendChild(btn);
  $('shortcutList').appendChild(li);
  $('shortcutName').value = ''; $('shortcutUrl').value = '';
});

/* Branding helpers */
$('genMaskable').addEventListener('click', async () => {
  log('ساخت آیکن maskable از 512...');
  const src = $('icon512').files[0] || null;
  const base = await fitToCanvas(src, 512);
  const canvas = await blobToCanvas(base);
  const ctx = canvas.getContext('2d');
  ctx.strokeStyle = 'rgba(255,255,255,0.25)'; ctx.lineWidth = 32; ctx.beginPath(); ctx.arc(256,256,224,0,Math.PI*2); ctx.stroke();
  canvas.toBlob(b => { const dl = document.createElement('a'); dl.href = URL.createObjectURL(b); dl.download = 'icon-512-maskable.png'; dl.click(); log('آیکن maskable دانلود شد','ok'); }, 'image/png');
});
$('auto192').addEventListener('click', async () => {
  log('تولید 192 از 512...');
  const src = $('icon512').files[0] || null;
  const blob = await fitToCanvas(src, 192);
  const dl = document.createElement('a'); dl.href = URL.createObjectURL(blob); dl.download = 'icon-192.png'; dl.click();
  log('آیکن 192 دانلود شد','ok');
});
$('autoSplash').addEventListener('click', async () => {
  log('تولید اسپلش از آیکن...');
  const src = $('icon512').files[0] || null;
  const icon = await fitToCanvas(src, 256);
  const icCanvas = await blobToCanvas(icon);
  const c = document.createElement('canvas'); c.width=1024; c.height=500;
  const ctx = c.getContext('2d'); ctx.fillStyle = $('bgColor').value; ctx.fillRect(0,0,1024,500);
  ctx.drawImage(icCanvas,(1024-256)/2,(500-256)/2,256,256);
  c.toBlob(b => { const dl = document.createElement('a'); dl.href = URL.createObjectURL(b); dl.download='splash.png'; dl.click(); log('اسپلش دانلود شد','ok'); }, 'image/png');
});

/* Preview icon */
async function updatePreviewIcon(){
  const icon = await fitToCanvas($('icon512').files[0], 96);
  const canvas = $('previewIcon'); const bmp = await createImageBitmap(icon);
  const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,96,96); ctx.drawImage(bmp,0,0,96,96);
}
$('icon512').addEventListener('change', updatePreviewIcon); updatePreviewIcon();

/* Build ZIP */
$('buildPWA').addEventListener('click', async () => {
  try {
    log('شروع ساخت ZIP...');
    const appName = $('appName').value.trim() || 'App';
    const siteUrl = $('siteUrl').value.trim(); if (!/^https?:\/\/.+/.test(siteUrl)) { log('آدرس start_url معتبر نیست','err'); return; }
    const scope = $('scope').value.trim() || '/';
    const themeColor = $('themeColor').value || '#7c3aed';
    const bgColor = $('bgColor').value || '#ffffff';
    const display = $('display').value || 'standalone';
    const description = $('description').value || '';

    const icon512 = await fitToCanvas($('icon512').files[0], 512);
    const icon192 = await fitToCanvas($('icon192').files[0], 192);
    const splash = $('splash').files[0] || null;

    const manifest = {
      name: appName,
      short_name: appName,
      start_url: siteUrl,
      scope, display,
      background_color: bgColor,
      theme_color: themeColor,
      description,
      icons: [
        { src: "icon-192.png", sizes: "192x192", type: "image/png", purpose: "any" },
        { src: "icon-512.png", sizes: "512x512", type: "image/png", purpose: "any" },
        { src: "icon-512-maskable.png", sizes: "512x512", type: "image/png", purpose: "maskable" }
      ],
      shortcuts: S.shortcuts,
      categories: ($('categories').value || '').split(',').map(s => s.trim()).filter(Boolean),
      screenshots: ($('screenshots').value || '').split(',').map(u => ({ src: u.trim(), sizes: "1024x500", type: "image/png" })).filter(s => /^https?:\/\//.test(s.src))
    };

    const sw = `/* Cache-first with versioning */
const VERSION = '${Date.now()}';
const CORE = ['./','./index.html','./manifest.json','./icon-192.png','./icon-512.png'];
self.addEventListener('install',e=>{
  e.waitUntil(caches.open('pwa-'+VERSION).then(c=>c.addAll(CORE)));
});
self.addEventListener('activate',e=>{
  e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!=='pwa-'+VERSION).map(k=>caches.delete(k)))));
});
self.addEventListener('fetch',e=>{
  const req=e.request;
  e.respondWith(caches.match(req).then(r=>r||fetch(req).then(resp=>{
    if(req.method==='GET' && resp.ok){const copy=resp.clone(); caches.open('pwa-'+VERSION).then(c=>c.put(req,copy));}
    return resp;
  }).catch(()=>r)));
});`;

    const html = `<!doctype html><html lang="fa"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="./manifest.json"><meta name="theme-color" content="${themeColor}">
<title>${appName}</title><style>body{font-family:system-ui;margin:20px}</style></head>
<body><h1>${appName}</h1><p>${description || 'PWA آماده نصب'}</p>
<script>if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js').catch(console.error)}</script>
</body></html>`;
</script>
</body>
</html>
