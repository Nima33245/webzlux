<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>اپ‌ساز PWA + APK</title>
  <!-- Tailwind CDN (برای توسعه). برای پروداکشن بهتر است از CLI/PostCSS استفاده کنید. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- کتابخانه‌ها -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; }
    .card { box-shadow: 0 4px 14px rgba(0,0,0,.08); border-radius: 14px; }
    .pwa-check.pass { color: #16a34a; }
    .pwa-check.fail { color: #ef4444; }
    .log-entry { animation: fadeIn .25s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">

  <div class="container mx-auto p-6 max-w-5xl">
    <h1 class="text-3xl font-bold mb-6">ابزار ساخت PWA + APK</h1>

    <!-- فرم -->
    <div class="card bg-white p-6 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">نام اپلیکیشن *</label>
          <input id="appName" class="w-full border p-2 rounded" placeholder="فروشگاه من">
        </div>
        <div>
          <label class="block text-sm mb-1">شناسه پکیج *</label>
          <input id="packageId" class="w-full border p-2 rounded" placeholder="com.example.app">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">آدرس سایت (start_url) *</label>
          <input id="startUrl" class="w-full border p-2 rounded" placeholder="https://example.com">
          <p class="text-xs text-gray-500 mt-1">باید با https:// شروع شود</p>
        </div>
        <div>
          <label class="block text-sm mb-1">Scope</label>
          <input id="scope" class="w-full border p-2 rounded" value="/" placeholder="/">
        </div>
        <div>
          <label class="block text-sm mb-1">حالت نمایش</label>
          <select id="displayMode" class="w-full border p-2 rounded">
            <option value="standalone">standalone</option>
            <option value="fullscreen">fullscreen</option>
            <option value="minimal-ui">minimal-ui</option>
            <option value="browser">browser</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">رنگ تم</label>
          <div class="flex gap-2">
            <input type="color" id="themeColor" class="w-10 h-10 p-0 border-0 cursor-pointer" value="#0ea5e9">
            <input type="text" id="themeColorHex" class="flex-1 border p-2 rounded" value="#0ea5e9">
          </div>
        </div>
        <div>
          <label class="block text-sm mb-1">رنگ پس‌زمینه</label>
          <div class="flex gap-2">
            <input type="color" id="backgroundColor" class="w-10 h-10 p-0 border-0 cursor-pointer" value="#ffffff">
            <input type="text" id="backgroundColorHex" class="flex-1 border p-2 rounded" value="#ffffff">
          </div>
        </div>

        <!-- آیکن‌ها و اسپلش -->
        <div>
          <label class="block text-sm mb-1">آیکن 512×512 *</label>
          <input type="file" id="icon512" accept="image/*" class="w-full">
          <div id="icon512Preview" class="mt-2 text-sm text-gray-500">بدون فایل</div>
        </div>
        <div>
          <label class="block text-sm mb-1">آیکن 192×192</label>
          <input type="file" id="icon192" accept="image/*" class="w-full">
          <div id="icon192Preview" class="mt-2 text-sm text-gray-500">بدون فایل</div>
          <button id="generate192" class="mt-2 px-3 py-1 bg-blue-100 text-blue-700 border rounded">تولید از 512</button>
        </div>
        <div>
          <label class="block text-sm mb-1">تصویر اسپلش (اختیاری)</label>
          <input type="file" id="splashImage" accept="image/*" class="w-full">
          <div id="splashPreview" class="mt-2 text-sm text-gray-500">بدون فایل</div>
          <button id="generateSplash" class="mt-2 px-3 py-1 bg-blue-100 text-blue-700 border rounded">تولید از آیکن</button>
        </div>
        <div>
          <label class="block text-sm mb-1">میان‌برها (Shortcuts)</label>
          <textarea id="shortcuts" rows="3" class="w-full border p-2 rounded" placeholder="نام1|URL1&#10;نام2|URL2"></textarea>
          <p class="text-xs text-gray-500 mt-1">هر خط: نام|URL</p>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Screenshots (هر خط یک URL)</label>
          <textarea id="screenshots" rows="3" class="w-full border p-2 rounded" placeholder="https://example.com/s1.png&#10;https://example.com/s2.png"></textarea>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">دسته‌بندی‌ها (با کاما جدا)</label>
          <input id="categories" class="w-full border p-2 rounded" placeholder="business, shopping">
        </div>
      </div>

      <div class="mt-4 flex gap-4">
        <button id="resetForm" class="flex-1 bg-red-200 p-2 rounded">پاک‌سازی فرم</button>
        <button id="buildPwa" class="flex-1 bg-green-600 text-white p-2 rounded">ساخت فایل‌های PWA (ZIP)</button>
        <button id="openQr" class="flex-1 bg-indigo-600 text-white p-2 rounded">QR Code</button>
      </div>
    </div>

    <!-- اعتبارسنجی -->
    <div class="card bg-white p-6 mb-6">
      <h2 class="font-bold mb-3">اعتبارسنجی PWA</h2>
      <ul class="space-y-1">
        <li><span id="httpsCheck" class="pwa-check fail">✖</span> آدرس HTTPS</li>
        <li><span id="manifestCheck" class="pwa-check fail">✖</span> آیکن 512 موجود</li>
        <li><span id="swCheck" class="pwa-check pass">✔</span> Service Worker تولید می‌شود</li>
      </ul>
    </div>

    <!-- پیش‌نمایش -->
    <div class="card bg-white p-6 mb-6 text-center">
      <div id="previewIcon" class="w-24 h-24 mx-auto rounded bg-blue-100 flex items-center justify-center">
        <span id="previewIconLetter" class="text-3xl font-bold text-blue-600">A</span>
      </div>
      <h3 id="previewName" class="text-xl font-bold mt-2">نام اپلیکیشن</h3>
      <p id="previewDesc" class="text-gray-600">یک اپلیکیشن پیش‌رونده حرفه‌ای</p>
    </div>

    <!-- لاگ -->
    <div class="card bg-white p-6">
      <h2 class="font-bold mb-3">لاگ‌های سیستم</h2>
      <ul id="logList" class="text-sm text-gray-700 space-y-1"></ul>
    </div>
  </div>

  <!-- QR Modal -->
  <div id="qrModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">QR Code برای نصب PWA</h3>
        <button id="closeQr" class="text-gray-500">✕</button>
      </div>
      <div id="qrCodeContainer" class="inline-block p-4 bg-white rounded-xl mb-4"></div>
      <p class="text-gray-600 mb-4">با دوربین گوشی اسکن کنید</p>
      <div class="flex gap-3">
        <button id="downloadQr" class="px-4 py-2 bg-indigo-600 text-white rounded">دانلود QR</button>
      </div>
    </div>
  </div>

  <script>
    class PwaBuilder {
      constructor() {
        // عناصر
        this.appName = document.getElementById('appName');
        this.packageId = document.getElementById('packageId');
        this.startUrl = document.getElementById('startUrl');
        this.scope = document.getElementById('scope');
        this.displayMode = document.getElementById('displayMode');
        this.themeColor = document.getElementById('themeColor');
        this.themeColorHex = document.getElementById('themeColorHex');
        this.backgroundColor = document.getElementById('backgroundColor');
        this.backgroundColorHex = document.getElementById('backgroundColorHex');
        this.icon512 = document.getElementById('icon512');
        this.icon192 = document.getElementById('icon192');
        this.splashImage = document.getElementById('splashImage');
        this.icon512Preview = document.getElementById('icon512Preview');
        this.icon192Preview = document.getElementById('icon192Preview');
        this.splashPreview = document.getElementById('splashPreview');
        this.shortcuts = document.getElementById('shortcuts');
        this.screenshots = document.getElementById('screenshots');
        this.categories = document.getElementById('categories');

        this.httpsCheck = document.getElementById('httpsCheck');
        this.manifestCheck = document.getElementById('manifestCheck');
        this.swCheck = document.getElementById('swCheck');

        this.previewIcon = document.getElementById('previewIcon');
        this.previewIconLetter = document.getElementById('previewIconLetter');
        this.previewName = document.getElementById('previewName');
        this.previewDesc = document.getElementById('previewDesc');

        this.logList = document.getElementById('logList');

        this.generate192Btn = document.getElementById('generate192');
        this.generateSplashBtn = document.getElementById('generateSplash');
        this.resetFormBtn = document.getElementById('resetForm');
        this.buildPwaBtn = document.getElementById('buildPwa');

        this.qrModal = document.getElementById('qrModal');
        this.openQrBtn = document.getElementById('openQr');
        this.closeQrBtn = document.getElementById('closeQr');
        this.qrCodeContainer = document.getElementById('qrCodeContainer');
        this.downloadQrBtn = document.getElementById('downloadQr');

        // رویدادها
        document.addEventListener('DOMContentLoaded', () => this.initialize());
      }

      initialize() {
        // همگام‌سازی رنگ‌ها
        const hexRe = /^#[0-9A-F]{6}$/i;
        this.themeColor.addEventListener('input', () => {
          this.themeColorHex.value = this.themeColor.value;
          this.updatePreview();
        });
        this.themeColorHex.addEventListener('input', () => {
          if (hexRe.test(this.themeColorHex.value)) this.themeColor.value = this.themeColorHex.value;
          this.updatePreview();
        });
        this.backgroundColor.addEventListener('input', () => {
          this.backgroundColorHex.value = this.backgroundColor.value;
          this.updatePreview();
        });
        this.backgroundColorHex.addEventListener('input', () => {
          if (hexRe.test(this.backgroundColorHex.value)) this.backgroundColor.value = this.backgroundColorHex.value;
          this.updatePreview();
        });

        // فایل‌ها
        this.icon512.addEventListener('change', (e) => this.handleFilePreview(e, this.icon512Preview));
        this.icon192.addEventListener('change', (e) => this.handleFilePreview(e, this.icon192Preview));
        this.splashImage.addEventListener('change', (e) => this.handleFilePreview(e, this.splashPreview));

        // دکمه‌ها
        this.generate192Btn.addEventListener('click', () => this.generateIcon192());
        this.generateSplashBtn.addEventListener('click', () => this.generateSplashImage());
        this.resetFormBtn.addEventListener('click', () => this.resetForm());
        this.buildPwaBtn.addEventListener('click', () => this.buildZip());

        // QR
        this.openQrBtn.addEventListener('click', () => this.openQr());
        this.closeQrBtn.addEventListener('click', () => this.qrModal.classList.add('hidden'));
        this.downloadQrBtn.addEventListener('click', () => this.downloadQr());

        // تغییرات فرم → پیش‌نمایش و اعتبارسنجی
        ['input','change'].forEach(evt => {
          document.querySelectorAll('input, textarea, select').forEach(el => {
            el.addEventListener(evt, () => { this.updatePreview(); this.validate(); this.saveForm(); });
          });
        });

        // بازیابی فرم
        this.loadForm();

        // شروع
        this.updatePreview();
        this.validate();
        this.log('سیستم آماده است. فرم را پر کنید.', 'info');
      }

      handleFilePreview(e, targetEl) {
        const file = e.target.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        targetEl.innerHTML = `<img src="${url}" class="w-16 h-16 object-cover rounded">`;
        this.log(`فایل ${file.name} بارگذاری شد`, 'ok');
        this.validate();
      }

      updatePreview() {
        const name = this.appName.value || 'نام اپلیکیشن';
        const letter = name.charAt(0).toUpperCase() || 'A';
        this.previewIconLetter.textContent = letter;
        this.previewName.textContent = name;
        this.previewDesc.textContent = this.appName.value ? `یک اپلیکیشن پیش‌رونده برای ${name}` : 'یک اپلیکیشن پیش‌رونده حرفه‌ای';
        this.previewIcon.style.backgroundColor = this.themeColor.value + '15';
        this.previewIconLetter.style.color = this.themeColor.value;
      }

      validate() {
        const httpsOk = (this.startUrl.value || '').startsWith('https://');
        this.setCheck(this.httpsCheck, httpsOk);
        const iconOk = (this.icon512.files && this.icon512.files.length > 0) || !!this._icon512DataUrl;
        this.setCheck(this.manifestCheck, iconOk);
        const swOk = !!this.appName.value && !!this.startUrl.value;
        this.setCheck(this.swCheck, swOk);
      }

      setCheck(el, ok) {
        el.textContent = ok ? '✔' : '✖';
        el.classList.toggle('pass', ok);
        el.classList.toggle('fail', !ok);
      }

      generateIcon192() {
        if (!this.icon512.files || !this.icon512.files[0]) return this.log('ابتدا آیکن 512×512 را آپلود کنید', 'error');
        const img = new Image();
        img.onload = () => {
          const c = document.createElement('canvas'); c.width = 192; c.height = 192;
          const ctx = c.getContext('2d');
          // حفظ نسبت و مرکز
          const scale = Math.min(192 / img.width, 192 / img.height);
          const w = img.width * scale, h = img.height * scale;
          ctx.clearRect(0,0,192,192);
          ctx.drawImage(img, (192 - w)/2, (192 - h)/2, w, h);
          const dataUrl = c.toDataURL('image/png');
          this.icon192Preview.innerHTML = `<img src="${dataUrl}" class="w-16 h-16 object-cover rounded">`;
          this._icon192DataUrl = dataUrl;
          this.log('آیکن 192×192 تولید شد', 'ok');
        };
        img.src = URL.createObjectURL(this.icon512.files[0]);
      }

      generateSplashImage() {
        if (!this.icon512.files || !this.icon512.files[0]) return this.log('ابتدا آیکن 512×512 را آپلود کنید', 'error');
        const img = new Image();
        img.onload = () => {
          const c = document.createElement('canvas'); c.width = 1024; c.height = 500;
          const ctx = c.getContext('2d');
          ctx.fillStyle = this.backgroundColor.value; ctx.fillRect(0,0,1024,500);
          const size = 256;
          ctx.drawImage(img, (1024 - size)/2, (500 - size)/2, size, size);
          const dataUrl = c.toDataURL('image/png');
          this.splashPreview.innerHTML = `<img src="${dataUrl}" class="w-32 h-16 object-cover rounded">`;
          this._splashDataUrl = dataUrl;
          this.log('اسپلش تولید شد', 'ok');
        };
        img.src = URL.createObjectURL(this.icon512.files[0]);
      }

      async buildZip() {
        if (!this.appName.value || !this.packageId.value || !this.startUrl.value) return this.log('فیلدهای ضروری را پر کنید', 'error');
        if (!this.startUrl.value.startsWith('https://')) return this.log('آدرس باید با https:// شروع شود', 'error');
        if (!this.icon512.files || this.icon512.files.length === 0) return this.log('آیکن 512×512 لازم است', 'error');

        this.log('ساخت ZIP شروع شد...', 'info');
        try {
          const zip = new JSZip();
          zip.file('manifest.json', JSON.stringify(this.createManifest(), null, 2));
          zip.file('service-worker.js', this.createServiceWorker());
          zip.file('index.html', this.createIndexHtml());

          // آیکن‌ها
          await this.addFileToZip(zip, this.icon512, 'icon-512.png');
          if (this.icon192.files && this.icon192.files[0]) {
            await this.addFileToZip(zip, this.icon192, 'icon-192.png');
          } else if (this._icon192DataUrl) {
            await this.addDataUrlToZip(zip, this._icon192DataUrl, 'icon-192.png');
          } else {
            // تولید فوری
            this.generateIcon192();
            if (this._icon192DataUrl) await this.addDataUrlToZip(zip, this._icon192DataUrl, 'icon-192.png');
          }

          // اسپلش
          if (this.splashImage.files && this.splashImage.files[0]) {
            await this.addFileToZip(zip, this.splashImage, 'splash.png');
          } else if (this._splashDataUrl) {
            await this.addDataUrlToZip(zip, this._splashDataUrl, 'splash.png');
          }

          zip.file('README.md', this.createReadme());

          const blob = await zip.generateAsync({ type: 'blob' });
          const name = (this.appName.value || 'pwa').replace(/[^a-z0-9]/gi, '_').toLowerCase();
          saveAs(blob, `${name}-pwa.zip`);
          this.log('ZIP با موفقیت دانلود شد', 'ok');
        } catch (e) {
          this.log('خطا در ساخت ZIP: ' + e.message, 'error');
        }
      }

      createManifest() {
        const shortcuts = (this.shortcuts.value || '').split('\n').map(l => l.trim()).filter(Boolean).map(l => {
          const [name, url] = l.split('|').map(x => x.trim());
          return name && url ? { name, short_name: name, url } : null;
        }).filter(Boolean);

        const screenshots = (this.screenshots.value || '').split('\n').map(u => u.trim()).filter(u => /^https?:\/\//.test(u)).map(u => ({ src: u, sizes: '1024x500', type: 'image/png' }));

        const icons = [
          { src: 'icon-192.png', sizes: '192x192', type: 'image/png', purpose: 'any' },
          { src: 'icon-512.png', sizes: '512x512', type: 'image/png', purpose: 'any' }
        ];

        const manifest = {
          name: this.appName.value,
          short_name: (this.appName.value || 'App').substring(0,12),
          start_url: this.startUrl.value,
          scope: this.scope.value || '/',
          display: this.displayMode.value,
          background_color: this.backgroundColor.value,
          theme_color: this.themeColor.value,
          icons,
          shortcuts,
          screenshots
        };

        if (this.categories.value) {
          manifest.categories = this.categories.value.split(',').map(c => c.trim()).filter(Boolean);
        }
        return manifest;
      }

      createServiceWorker() {
        const version = Date.now();
        return `const CACHE='pwa-cache-${version}';
const CORE=['./','./index.html','./manifest.json','./icon-192.png','./icon-512.png'];
self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(CORE)))});
self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))))});
self.addEventListener('fetch',e=>{
  const req=e.request;
  e.respondWith(caches.match(req).then(r=>{
    return r || fetch(req).then(resp=>{
      if(req.method==='GET' && resp.ok){
        const copy=resp.clone();
        caches.open(CACHE).then(c=>c.put(req,copy));
      }
      return resp;
    }).catch(()=>r);
  }));
});`;
      }

      createIndexHtml() {
        return `<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>${this.appName.value}</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="${this.themeColor.value}">
  <style>
    body{font-family:system-ui,sans-serif;margin:0;padding:20px;background:${this.backgroundColor.value};color:#333;text-align:center;min-height:100vh;display:flex;flex-direction:column;justify-content:center}
    .app-icon{width:128px;height:128px;margin:0 auto 20px;background:${this.themeColor.value}15;border-radius:24px;display:flex;align-items:center;justify-content:center;font-size:48px;font-weight:bold;color:${this.themeColor.value}}
    h1{color:${this.themeColor.value};margin-bottom:10px}
    a{color:${this.themeColor.value}}
  </style>
</head>
<body>
  <div class="app-icon">${(this.appName.value || 'A').charAt(0)}</div>
  <h1>${this.appName.value || 'اپ پیش‌رونده'}</h1>
  <p>این اپلیکیشن با ابزار سازنده PWA ساخته شده است.</p>
  <p><a href="./manifest.json" target="_blank">مشاهده manifest.json</a></p>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').catch(console.error);
    }
  </script>
</body>
</html>`;
      }

      createReadme() {
        return `# ${this.appName.value}
این اپلیکیشن با ابزار PWA Builder ساخته شده است.

## استقرار
- همه فایل‌ها را روی هاست HTTPS قرار دهید.
- فایل‌های لازم در ریشه:
  - index.html
  - manifest.json
  - service-worker.js
  - icon-192.png
  - icon-512.png
  - (اختیاری) splash.png

## اطلاعات
- نام: ${this.appName.value}
- آدرس: ${this.startUrl.value}
- پکیج: ${this.packageId.value}
- رنگ تم: ${this.themeColor.value}

## تبدیل به APK
از ورک‌فلو GitHub Actions استفاده کنید یا Bubblewrap را روی سیستم نصب کنید.`;
      }

      async addFileToZip(zip, input, name) {
        if (!(input.files && input.files[0])) return;
        const dataUrl = await new Promise(resolve => {
          const r = new FileReader();
          r.onload = e => resolve(e.target.result);
          r.readAsDataURL(input.files[0]);
        });
        const base64 = dataUrl.split(',')[1];
        zip.file(name, base64, { base64: true });
      }

      async addDataUrlToZip(zip, dataUrl, name) {
        if (!dataUrl) return;
        const base64 = dataUrl.split(',')[1];
        zip.file(name, base64, { base64: true });
      }

      openQr() {
        if (!this.startUrl.value) return this.log('آدرس سایت را وارد کنید', 'error');
        const qr = qrcode(0, 'M');
        qr.addData(this.startUrl.value);
        qr.make();
        const hex = this.themeColor.value.replace('#','');
        const imgTag = qr.createImgTag(8, 0, hex, 'ffffff');
        this.qrCodeContainer.innerHTML = imgTag;
        this.qrModal.classList.remove('hidden');
        this.qrModal.classList.add('flex');
        this.log('QR ساخته شد', 'ok');
      }

      downloadQr() {
        const img = this.qrCodeContainer.querySelector('img');
        if (img && img.src && img.src.startsWith('data:image')) {
          const a = document.createElement('a');
          a.href = img.src;
          a.download = `${this.appName.value || 'pwa'}-qr.png`;
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
          this.log('QR دانلود شد', 'ok');
        } else {
          this.log('QR برای دانلود آماده نیست', 'warn');
        }
      }

      resetForm() {
        if (!confirm('آیا از پاک‌سازی فرم مطمئن هستید؟')) return;
        document.querySelectorAll('input, textarea').forEach(el => {
          if (el.type === 'color') return;
          el.value = '';
        });
        this.displayMode.value = 'standalone';
        this.themeColor.value = '#0ea5e9';
        this.themeColorHex.value = '#0ea5e9';
        this.backgroundColor.value = '#ffffff';
        this.backgroundColorHex.value = '#ffffff';
        this.scope.value = '/';
        this.icon512Preview.innerHTML = 'بدون فایل';
        this.icon192Preview.innerHTML = 'بدون فایل';
        this.splashPreview.innerHTML = 'بدون فایل';
        this._icon192DataUrl = null;
        this._splashDataUrl = null;
        localStorage.removeItem('appBuilderFormData');
        this.updatePreview(); this.validate();
        this.log('فرم پاک شد', 'warn');
      }

      saveForm() {
        const data = {
          appName: this.appName.value,
          packageId: this.packageId.value,
          startUrl: this.startUrl.value,
          scope: this.scope.value,
          displayMode: this.displayMode.value,
          themeColor: this.themeColor.value,
          backgroundColor: this.backgroundColor.value,
          shortcuts: this.shortcuts.value,
          screenshots: this.screenshots.value,
          categories: this.categories.value
        };
        localStorage.setItem('appBuilderFormData', JSON.stringify(data));
      }

      loadForm() {
        const raw = localStorage.getItem('appBuilderFormData');
        if (!raw) return;
        try {
          const d = JSON.parse(raw);
          this.appName.value = d.appName || '';
          this.packageId.value = d.packageId || '';
          this.startUrl.value = d.startUrl || '';
          this.scope.value = d.scope || '/';
          this.displayMode.value = d.displayMode || 'standalone';
          this.themeColor.value = d.themeColor || '#0ea5e9';
          this.themeColorHex.value = d.themeColor || '#0ea5e9';
          this.backgroundColor.value = d.backgroundColor || '#ffffff';
          this.backgroundColorHex.value = d.backgroundColor || '#ffffff';
          this.shortcuts.value = d.shortcuts || '';
          this.screenshots.value = d.screenshots || '';
          this.categories.value = d.categories || '';
          this.log('اطلاعات ذخیره‌شده بازیابی شد', 'ok');
        } catch {
          this.log('خطا در بازیابی اطلاعات', 'error');
        }
      }

      log(message, level='info') {
        const ts = new Date().toLocaleTimeString('fa-IR');
        const li = document.createElement('li');
        li.className = 'log-entry';
        let color = '#374151';
        if (level === 'ok') color = '#16a34a';
        else if (level === 'warn') color = '#ca8a04';
        else if (level === 'error') color = '#dc2626';
        li.style.color = color;
        li.textContent = `[${ts}] ${message}`;
        this.logList.appendChild(li);
        this.logList.scrollTop = this.logList.scrollHeight;
      }
    }

    // راه‌اندازی
    document.addEventListener('DOMContentLoaded', () => new PwaBuilder());
  </script>
</body>
</html>
