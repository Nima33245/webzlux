<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ابزار اپ‌ساز PWA + APK</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/file-saverjs@2014-11-29/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-white transition-colors duration-300">
    <div class="container mx-auto p-4">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-center">ابزار اپ‌ساز PWA + APK</h1>
        </header>
        <form id="appBuilderForm" class="space-y-6">
            <div class="card bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">اطلاعات اپلیکیشن</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="appName" class="block text-sm font-medium mb-1">نام اپلیکیشن:</label>
                        <input type="text" id="appName" name="appName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="packageId" class="block text-sm font-medium mb-1">شناسه پکیج اندروید:</label>
                        <input type="text" id="packageId" name="packageId" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="startUrl" class="block text-sm font-medium mb-1">آدرس سایت (start_url):</label>
                        <input type="url" id="startUrl" name="startUrl" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="scope" class="block text-sm font-medium mb-1">Scope:</label>
                        <input type="text" id="scope" name="scope" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="themeColor" class="block text-sm font-medium mb-1">رنگ تم:</label>
                        <input type="color" id="themeColor" name="themeColor" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" value="#ffffff">
                    </div>
                    <div>
                        <label for="backgroundColor" class="block text-sm font-medium mb-1">رنگ پس‌زمینه:</label>
                        <input type="color" id="backgroundColor" name="backgroundColor" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" value="#ffffff">
                    </div>
                    <div>
                        <label for="displayMode" class="block text-sm font-medium mb-1">Display Mode:</label>
                        <select id="displayMode" name="displayMode" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="standalone">Standalone</option>
                            <option value="fullscreen">Fullscreen</option>
                            <option value="minimal-ui">Minimal UI</option>
                            <option value="browser">Browser</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">آیکن‌ها و تصویر اسپلش</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="icon512" class="block text-sm font-medium mb-1">آیکن 512×512:</label>
                        <input type="file" id="icon512" name="icon512" accept="image/*" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="icon192" class="block text-sm font-medium mb-1">آیکن 192×192:</label>
                        <input type="file" id="icon192" name="icon192" accept="image/*" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="splashImage" class="block text-sm font-medium mb-1">تصویر اسپلش (اختیاری):</label>
                        <input type="file" id="splashImage" name="splashImage" accept="image/*" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <div class="card bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">تنظیمات پیشرفته</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="categories" class="block text-sm font-medium mb-1">Categories:</label>
                        <input type="text" id="categories" name="categories" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="screenshots" class="block text-sm font-medium mb-1">Screenshots (URL):</label>
                        <textarea id="screenshots" name="screenshots" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="shortcuts" class="block text-sm font-medium mb-1">Shortcuts (نام + URL):</label>
                        <textarea id="shortcuts" name="shortcuts" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center">
                <button type="button" id="resetButton" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">پاک‌سازی فرم</button>
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">ساخت فایل ZIP</button>
            </div>
        </form>

        <div id="preview" class="mt-8 card bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">پیش‌نمایش زنده</h2>
            <div class="flex flex-col items-center">
                <img id="previewIcon" src="" alt="آیکن اپلیکیشن" class="w-16 h-16 rounded-full mb-2">
                <h3 id="previewName" class="text-lg font-bold"></h3>
                <p id="previewDescription" class="text-gray-600 dark:text-gray-400"></p>
            </div>
        </div>

        <div id="logs" class="mt-8 card bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">لاگ‌ها</h2>
            <ul id="logList" class="list-disc pl-6 space-y-2"></ul>
        </div>

        <div id="qrCodeContainer" class="mt-8 card bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">QR Code</h2>
            <div id="qrCode" class="mx-auto"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('appBuilderForm');
            const resetButton = document.getElementById('resetButton');
            const preview = document.getElementById('preview');
            const previewIcon = document.getElementById('previewIcon');
            const previewName = document.getElementById('previewName');
            const previewDescription = document.getElementById('previewDescription');
            const logList = document.getElementById('logList');
            const qrCodeContainer = document.getElementById('qrCodeContainer');
            const qrCode = document.getElementById('qrCode');

            function log(message, level = 'info') {
                const timestamp = new Date().toLocaleString();
                const logItem = document.createElement('li');
                logItem.className = `text-${level === 'error' ? 'red' : level === 'warn' ? 'orange' : 'gray'}-600 dark:text-${level === 'error' ? 'red' : level === 'warn' ? 'orange' : 'gray'}-400`;
                logItem.textContent = `[${timestamp}] ${message}`;
                logList.appendChild(logItem);
            }

            function saveFormToLocalStorage() {
                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                });
                localStorage.setItem('appBuilderFormData', JSON.stringify(data));
            }

            function loadFormFromLocalStorage() {
                const data = JSON.parse(localStorage.getItem('appBuilderFormData'));
                if (data) {
                    Object.keys(data).forEach(key => {
                        const input = form.querySelector(`[name="${key}"]`);
                        if (input) {
                            input.value = data[key];
                        }
                    });
                }
            }

            function generateQRCode(text, color) {
                qrCode.innerHTML = '';
                const qr = qrcode(0, 'M');
                qr.addData(text);
                qr.make();
                const qrImg = qr.createImgTag({
                    colorDark: color,
                    colorLight: '#ffffff',
                    correctLevel: qrcode.CorrectLevel.H
                });
                qrCode.innerHTML = qrImg;
            }

            function createManifest(data) {
                return JSON.stringify({
                    name: data.appName,
                    short_name: data.appName,
                    start_url: data.startUrl,
                    scope: data.scope || '/',
                    display: data.displayMode,
                    theme_color: data.themeColor,
                    background_color: data.backgroundColor,
                    icons: [
                        {
                            src: 'icon-512.png',
                            sizes: '512x512',
                            type: 'image/png'
                        },
                        {
                            src: 'icon-192.png',
                            sizes: '192x192',
                            type: 'image/png'
                        }
                    ],
                    categories: data.categories ? data.categories.split(',').map(c => c.trim()) : [],
                    screenshots: data.screenshots ? data.screenshots.split('\n').map(s => ({ src: s.trim(), sizes: '640x480', type: 'image/png' })) : [],
                    shortcuts: data.shortcuts ? data.shortcuts.split('\n').map(s => {
                        const [name, url] = s.split('|').map(part => part.trim());
                        return { name, url };
                    }) : []
                }, null, 2);
            }

            function createServiceWorker() {
                return `
self.addEventListener('install', event => {
    event.waitUntil(
        caches.open('v1').then(cache => {
            return cache.addAll([
                '/',
                '/index.html',
                '/manifest.json',
                '/icon-512.png',
                '/icon-192.png'
            ]);
        })
    );
});

self.addEventListener('fetch', event => {
    event.respondWith(
        caches.match(event.request).then(response => {
            return response || fetch(event.request);
        })
    );
});
`;
            }

            function createIndexHTML() {
                return `
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${form.appName.value}</title>
    <link rel="manifest" href="/manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</head>
<body>
    <div class="container mx-auto p-4">
        <h1 class="text-4xl font-bold text-center">${form.appName.value}</h1>
        <p class="text-center">این یک صفحه تست برای PWA است.</p>
    </div>
</body>
</html>
`;
            }

            function createReadme() {
                return `
# ${form.appName.value}

این یک پروژه PWA است که با استفاده از ابزار اپ‌ساز ساخته شده است.

## نصب و اجرای پروژه

1. فایل‌ها را در یک پوشه قرار دهید.
2. سرور وب محلی را اجرا کنید (مانند http-server یا live-server).
3. با مرورگر به آدرس http://localhost:8080 بروید.

## فایل‌ها

- **index.html**: صفحه اصلی پروژه.
- **manifest.json**: فایل منیفست PWA.
- **service-worker.js**: سرویس ورکر PWA.
- **icon-512.png**: آیکن 512x512.
- **icon-192.png**: آیکن 192x192.
- **splash.png**: تصویر اسپلش (اگر وجود داشته باشد).
`;
            }

            async function handleFileUpload(fileInput, fileName) {
                const file = fileInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    return new Promise((resolve, reject) => {
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    }).then(dataUrl => {
                        log(`آپلود فایل ${fileName} موفقیت آمیز بود.`);
                        return { name: fileName, data: dataUrl };
                    });
                }
                return null;
            }

            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                log('شروع ساخت فایل ZIP...', 'ok');

                const formData = new FormData(form);
                const appName = formData.get('appName');
                const themeColor = formData.get('themeColor');
                const backgroundColor = formData.get('backgroundColor');

                preview.classList.remove('hidden');
                previewIcon.src = formData.get('icon512') ? URL.createObjectURL(formData.get('icon512')) : '';
                previewName.textContent = appName;
                previewDescription.textContent = `رنگ تم: ${themeColor}, رنگ پس‌زمینه: ${backgroundColor}`;

                const icon512 = await handleFileUpload(form.icon512, 'icon-512.png');
                const icon192 = await handleFileUpload(form.icon192, 'icon-192.png');
                const splashImage = await handleFileUpload(form.splashImage, 'splash.png');

                const files = [
                    { name: 'manifest.json', data: createManifest(formData) },
                    { name: 'service-worker.js', data: createServiceWorker() },
                    { name: 'index.html', data: createIndexHTML() },
                    { name: 'README.txt', data: createReadme() }
                ];

                if (icon512) files.push(icon512);
                if (icon192) files.push(icon192);
                if (splashImage) files.push(splashImage);

                const zip = new JSZip();
                files.forEach(file => {
                    zip.file(file.name, file.data.split(',')[1], { base64: true });
                });

                zip.generateAsync({ type: 'blob' }).then(blob => {
                    saveAs(blob, `${appName}.zip`);
                    log('فایل ZIP با موفقیت ساخته شد و دانلود شد.', 'ok');
                }).catch(error => {
                    log(`خطا در ساخت فایل ZIP: ${error.message}`, 'error');
                });
            });

            resetButton.addEventListener('click', () => {
                form.reset();
                localStorage.removeItem('appBuilderFormData');
                preview.classList.add('hidden');
                qrCodeContainer.classList.add('hidden');
                log('فرم با موفقیت پاک‌سازی شد.', 'warn');
            });

            form.addEventListener('input', () => {
                saveFormToLocalStorage();
            });

            loadFormFromLocalStorage();
        });
    </script>
</body>
</html>
