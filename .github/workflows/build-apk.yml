name: Build APK from PWA

on:
  workflow_dispatch:
    inputs:
      appName:
        description: 'نام اپلیکیشن'
        required: true
        default: 'MyApp'
      packageId:
        description: 'شناسه پکیج اندروید (مثلاً com.example.app)'
        required: true
        default: 'com.example.app'
      siteUrl:
        description: 'آدرس سایت (start_url)'
        required: true
        default: 'https://example.com'
      themeColor:
        description: 'رنگ تم'
        required: true
        default: '#0ea5e9'
      backgroundColor:
        description: 'رنگ پس‌زمینه'
        required: true
        default: '#ffffff'
      manifestUrl:
        description: 'آدرس manifest.json (اختیاری)'
        required: false

jobs:
  build-apk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Bubblewrap
        run: npm install -g @bubblewrap/cli

      - name: Prepare manifest and icons
        run: |
          mkdir workspace
          cd workspace

          if [ -n "${{ github.event.inputs.manifestUrl }}" ]; then
            echo "دانلود manifest.json از URL"
            curl -L "${{ github.event.inputs.manifestUrl }}" -o manifest.json
          else
            echo "ساخت manifest.json پیش‌فرض"
            cat > manifest.json <<EOF
            {
              "name": "${{ github.event.inputs.appName }}",
              "short_name": "${{ github.event.inputs.appName }}",
              "start_url": "${{ github.event.inputs.siteUrl }}",
              "scope": "/",
              "display": "standalone",
              "background_color": "${{ github.event.inputs.backgroundColor }}",
              "theme_color": "${{ github.event.inputs.themeColor }}",
              "icons": [
                { "src": "icon-192.png", "sizes": "192x192", "type": "image/png" },
                { "src": "icon-512.png", "sizes": "512x512", "type": "image/png" }
              ]
            }
EOF
            # ساخت آیکن‌های ساده با ImageMagick
            sudo apt-get update && sudo apt-get install -y imagemagick
            convert -size 192x192 xc:${{ github.event.inputs.themeColor }} icon-192.png
            convert -size 512x512 xc:${{ github.event.inputs.themeColor }} icon-512.png
          fi

      - name: Generate Android project
        working-directory: workspace
        run: |
          bubblewrap init --manifest=manifest.json --packageId="${{ github.event.inputs.packageId }}" --name="${{ github.event.inputs.appName }}"
          bubblewrap build

      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: ${{ github.event.inputs.appName }}-apk
          path: workspace/app-release-unsigned.apk
