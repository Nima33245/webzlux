name: Build APK from PWA

on:
  workflow_dispatch:
    inputs:
      appName:
        description: 'Ù†Ø§Ù… Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† (Ù…Ø«Ù„Ø§Ù‹: ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø§ÛŒÙ†ØªØ±Ù†ØªÛŒ Ù…Ù†)'
        required: true
        default: 'Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù…Ù†'
      packageId:
        description: 'Ø´Ù†Ø§Ø³Ù‡ Ù¾Ú©ÛŒØ¬ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹: com.example.app)'
        required: true
        default: 'com.example.pwa'
      siteUrl:
        description: 'Ø¢Ø¯Ø±Ø³ Ø³Ø§ÛŒØª (start_url)'
        required: true
        default: 'https://example.com'
      themeColor:
        description: 'Ø±Ù†Ú¯ ØªÙ… (hex)'
        required: true
        default: '#7c3aed'
      backgroundColor:
        description: 'Ø±Ù†Ú¯ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ (hex)'
        required: true
        default: '#ffffff'
      displayMode:
        description: 'Ø­Ø§Ù„Øª Ù†Ù…Ø§ÛŒØ´'
        required: true
        default: 'standalone'
        options:
          - standalone
          - fullscreen
          - minimal-ui
          - browser
      manifestUrl:
        description: 'URL Ù…Ø§Ù†ÙÛŒØ³Øª Ø¢Ù…Ø§Ø¯Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)'
        required: false
      icon192Url:
        description: 'URL Ø¢ÛŒÚ©Ù† 192 (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)'
        required: false
      icon512Url:
        description: 'URL Ø¢ÛŒÚ©Ù† 512 (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)'
        required: false
      splashUrl:
        description: 'URL Ø§Ø³Ù¾Ù„Ø´ 1024Ã—500 (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)'
        required: false
      signingMethod:
        description: 'Ø±ÙˆØ´ Ø§Ù…Ø¶Ø§'
        required: true
        default: 'bubblewrap'
        options:
          - bubblewrap
          - custom
          - none
      versionCode:
        description: 'Ú©Ø¯ Ù†Ø³Ø®Ù‡ (integer)'
        required: true
        default: '1'
      versionName:
        description: 'Ù†Ø§Ù… Ù†Ø³Ø®Ù‡ (string)'
        required: true
        default: '1.0.0'
      enableNotifications:
        description: 'ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†'
        required: true
        default: 'true'
        type: boolean
      enableLocation:
        description: 'ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¬ÛŒâ€ŒÙ¾ÛŒâ€ŒØ§Ø³'
        required: true
        default: 'false'
        type: boolean
      enableFullscreen:
        description: 'ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø­Ø§Ù„Øª ØªÙ…Ø§Ù…â€ŒØµÙØ­Ù‡'
        required: true
        default: 'false'
        type: boolean
      enableOrientationLock:
        description: 'Ù‚ÙÙ„â€ŒÚ©Ø±Ø¯Ù† Ø¬Ù‡Øª ØµÙØ­Ù‡'
        required: true
        default: 'false'
        type: boolean
      additionalUrls:
        description: 'URLÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ø¯Ú©Ø³ (ÛŒÚ© URL Ø¯Ø± Ù‡Ø± Ø®Ø·)'
        required: false

jobs:
  build-apk:
    runs-on: ubuntu-latest
    env:
      JAVA_OPTS: "-Djavax.net.ssl.trustStore=/dev/null -Djavax.net.ssl.trustStoreType=none"
      BUBBLEWRAP_VERSION: "1.17.0"
    steps:
      - name: ğŸ§ª Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø­ÛŒØ· Ú©Ø§Ø±
        id: setup
        run: |
          set -e
          echo "ğŸ”§ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø­ÛŒØ· Ú©Ø§Ø±"
          mkdir -p workspace && cd workspace
          
          # Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
          sudo apt-get update
          sudo apt-get install -y curl imagemagick openjdk-17-jdk zipalign
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ù†ØµØ¨ Node.js
          if ! command -v node &> /dev/null; then
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          
          # Ù†ØµØ¨ Bubblewrap
          echo "ğŸ“¦ Ù†ØµØ¨ Bubblewrap Ù†Ø³Ø®Ù‡ $BUBBLEWRAP_VERSION..."
          npm install -g @bubblewrap/cli@$BUBBLEWRAP_VERSION
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ù†ØµØ¨ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²
          bubblewrap --version
          echo "âœ… Bubblewrap Ù†ØµØ¨ Ø´Ø¯"

      - name: ğŸ“ ØªÙˆÙ„ÛŒØ¯ ÙØ§ÛŒÙ„ manifest.json
        if: github.event.inputs.manifestUrl == ''
        run: |
          cd workspace
          echo "ğŸ“ ØªÙˆÙ„ÛŒØ¯ ÙØ§ÛŒÙ„ manifest.json..."
          
          # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø±Ù Ø§ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ø¢ÛŒÚ©Ù† Ù¾ÛŒØ´â€ŒÙØ±Ø¶
          APP_INITIAL=$(echo "${{ github.event.inputs.appName }}" | cut -c1 | tr '[:lower:]' '[:upper:]')
          
          cat > manifest.json << EOF
          {
            "name": "${{ github.event.inputs.appName }}",
            "short_name": "${{ github.event.inputs.appName }}",
            "start_url": "${{ github.event.inputs.siteUrl }}",
            "scope": "/",
            "display": "${{ github.event.inputs.displayMode }}",
            "background_color": "${{ github.event.inputs.backgroundColor }}",
            "theme_color": "${{ github.event.inputs.themeColor }}",
            "icons": [
              {
                "src": "icon-192.png",
                "sizes": "192x192",
                "type": "image/png",
                "purpose": "any"
              },
              {
                "src": "icon-512.png",
                "sizes": "512x512",
                "type": "image/png",
                "purpose": "any"
              },
              {
                "src": "icon-512-maskable.png",
                "sizes": "512x512",
                "type": "image/png",
                "purpose": "maskable"
              }
            ],
            "related_applications": [],
            "prefer_related_applications": false
          }
EOF

      - name: ğŸŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ manifest Ø§Ø² URL
        if: github.event.inputs.manifestUrl != ''
        run: |
          cd workspace
          echo "ğŸŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ manifest Ø§Ø² URL..."
          curl -L -o manifest.json "${{ github.event.inputs.manifestUrl }}"
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† ÙØ§ÛŒÙ„ JSON
          if ! jq empty manifest.json 2>/dev/null; then
            echo "âŒ ÙØ§ÛŒÙ„ manifest.json Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª"
            exit 1
          fi

      - name: ğŸ–¼ï¸ ØªÙˆÙ„ÛŒØ¯ Ø¢ÛŒÚ©Ù†â€ŒÙ‡Ø§
        run: |
          cd workspace
          echo "ğŸ–¼ï¸ ØªÙˆÙ„ÛŒØ¯ Ø¢ÛŒÚ©Ù†â€ŒÙ‡Ø§..."
          
          # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø±Ù Ø§ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ø¢ÛŒÚ©Ù† Ù¾ÛŒØ´â€ŒÙØ±Ø¶
          APP_INITIAL=$(echo "${{ github.event.inputs.appName }}" | cut -c1 | tr '[:lower:]' '[:upper:]')
          
          # ØªÙˆÙ„ÛŒØ¯ Ø¢ÛŒÚ©Ù† 512x512
          if [ -n "${{ github.event.inputs.icon512Url }}" ]; then
            echo "ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¢ÛŒÚ©Ù† 512x512 Ø§Ø² URL..."
            curl -L -o icon-512.png "${{ github.event.inputs.icon512Url }}"
          else
            echo "ğŸ¨ ØªÙˆÙ„ÛŒØ¯ Ø¢ÛŒÚ©Ù† 512x512 Ù¾ÛŒØ´â€ŒÙØ±Ø¶..."
            convert -size 512x512 xc:${{ github.event.inputs.themeColor }} \
              -gravity center \
              -fill white \
              -pointsize 180 \
              -draw "text 0,0 '$APP_INITIAL'" \
              icon-512.png
          fi
          
          # ØªÙˆÙ„ÛŒØ¯ Ø¢ÛŒÚ©Ù† 192x192
          if [ -n "${{ github.event.inputs.icon192Url }}" ]; then
            echo "ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¢ÛŒÚ©Ù† 192x192 Ø§Ø² URL..."
            curl -L -o icon-192.png "${{ github.event.inputs.icon192Url }}"
          else
            echo "ğŸ¨ ØªÙˆÙ„ÛŒØ¯ Ø¢ÛŒÚ©Ù† 192x192 Ø§Ø² 512x512..."
            convert icon-512.png -resize 192x192 icon-192.png
          fi
          
          # ØªÙˆÙ„ÛŒØ¯ Ø¢ÛŒÚ©Ù† maskable
          echo "ğŸ¨ ØªÙˆÙ„ÛŒØ¯ Ø¢ÛŒÚ©Ù† maskable 512x512..."
          convert icon-512.png \
            -gravity center \
            -extent 512x512 \
            -fill none \
            -stroke white \
            -strokewidth 32 \
            -draw "circle 256,256 256,32" \
            icon-512-maskable.png
          
          # ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ± Ø§Ø³Ù¾Ù„Ø´
          if [ -n "${{ github.event.inputs.splashUrl }}" ]; then
            echo "ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ± Ø§Ø³Ù¾Ù„Ø´ Ø§Ø² URL..."
            curl -L -o splash.png "${{ github.event.inputs.splashUrl }}"
          else
            echo "ğŸ¨ ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ± Ø§Ø³Ù¾Ù„Ø´ Ø§Ø² Ø¢ÛŒÚ©Ù† 512x512..."
            convert icon-512.png \
              -resize 1024x500^ \
              -gravity center \
              -extent 1024x500 \
              -background ${{ github.event.inputs.backgroundColor }} \
              -flatten \
              splash.png
          fi
          
          # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
          for file in icon-512.png icon-192.png icon-512-maskable.png splash.png; do
            if [ ! -f "$file" ]; then
              echo "âŒ ÙØ§ÛŒÙ„ $file Ø³Ø§Ø®ØªÙ‡ Ù†Ø´Ø¯"
              exit 1
            fi
          done

      - name: ğŸ§© Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ PWA Ø§Ø³Ø§Ø³ÛŒ
        run: |
          cd workspace
          echo "ğŸ§© Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ PWA Ø§Ø³Ø§Ø³ÛŒ..."
          
          # Ø§ÛŒØ¬Ø§Ø¯ index.html
          cat > index.html << EOF
          <!doctype html>
          <html lang="fa">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
            <title>${{ github.event.inputs.appName }}</title>
            <link rel="manifest" href="./manifest.json">
            <meta name="theme-color" content="${{ github.event.inputs.themeColor }}">
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                margin: 0;
                padding: 20px;
                background-color: ${{ github.event.inputs.backgroundColor }};
                color: #333;
                text-align: center;
                min-height: 100vh;
                display: flex;
                flex-direction: column;
                justify-content: center;
              }
              .app-icon {
                width: 128px;
                height: 128px;
                margin: 0 auto 20px;
                background-color: ${{ github.event.inputs.themeColor }}15;
                border-radius: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 48px;
                font-weight: bold;
                color: ${{ github.event.inputs.themeColor }};
              }
              h1 {
                color: ${{ github.event.inputs.themeColor }};
                margin-bottom: 10px;
              }
              .install-button {
                background-color: ${{ github.event.inputs.themeColor }};
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 30px;
                font-size: 16px;
                cursor: pointer;
                margin-top: 20px;
                transition: opacity 0.3s;
              }
              .install-button:hover {
                opacity: 0.9;
              }
            </style>
          </head>
          <body>
            <div class="app-icon">$APP_INITIAL</div>
            <h1>${{ github.event.inputs.appName }}</h1>
            <p>Ø§ÛŒÙ† ÛŒÚ© Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù¾ÛŒØ´â€ŒØ±ÙˆÙ†Ø¯Ù‡ (PWA) Ø§Ø³Øª Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù†ØµØ¨ Ø´ÙˆØ¯.</p>
            <button class="install-button" id="installButton">Ù†ØµØ¨ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†</button>

            <script>
              let deferredPrompt;
              
              window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                const installButton = document.getElementById('installButton');
                installButton.textContent = 'Ù†ØµØ¨ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†';
                installButton.style.display = 'block';
                
                installButton.addEventListener('click', () => {
                  installButton.disabled = true;
                  installButton.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ù†ØµØ¨...';
                  
                  deferredPrompt.prompt();
                  
                  deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                      console.log('Ú©Ø§Ø±Ø¨Ø± Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø±Ø§ Ù†ØµØ¨ Ú©Ø±Ø¯');
                    } else {
                      console.log('Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ù†ØµØ¨ ØµØ±Ùâ€ŒÙ†Ø¸Ø± Ú©Ø±Ø¯');
                      installButton.textContent = 'Ù†ØµØ¨ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†';
                      installButton.disabled = false;
                    }
                    deferredPrompt = null;
                  });
                });
              });
              
              // Check if app is already installed
              window.addEventListener('appinstalled', (evt) => {
                document.getElementById('installButton').style.display = 'none';
                console.log('Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù†ØµØ¨ Ø´Ø¯');
              });
              
              // Register service worker
              if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                  navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                      console.log('ServiceWorker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                      console.error('ServiceWorker registration failed:', error);
                    });
                });
              }
            </script>
          </body>
          </html>
EOF
          
          # Ø§ÛŒØ¬Ø§Ø¯ service-worker.js
          cat > service-worker.js << EOF
// Service Worker Ø¨Ø±Ø§ÛŒ ${{ github.event.inputs.appName }}
const CACHE_NAME = 'pwa-${{ github.run_id }}';
const urlsToCache = [
  '/',
  '/index.html',
  '/manifest.json',
  '/icon-192.png',
  '/icon-512.png',
  '/icon-512-maskable.png'
];

self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => {
        console.log('Opened cache');
        return cache.addAll(urlsToCache);
      })
  );
});

self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request)
      .then(response => {
        if (response) {
          return response;
        }
        return fetch(event.request);
      })
  );
});

self.addEventListener('activate', event => {
  const cacheWhitelist = [CACHE_NAME];
  event.waitUntil(
    caches.keys().then(cacheNames => {
      return Promise.all(
        cacheNames.map(cacheName => {
          if (cacheWhitelist.indexOf(cacheName) === -1) {
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
});
EOF

      - name: ğŸ”‘ Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ keystore Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø¶Ø§
        if: github.event.inputs.signingMethod == 'bubblewrap'
        run: |
          cd workspace
          echo "ğŸ”‘ Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ keystore Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø¶Ø§..."
          
          # Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ keystore Ù‚Ø¨Ù„ÛŒ
          rm -f keystore.jks
          
          # Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø³ÙˆØ±Ø¯Ù‡Ø§ÛŒ ØªØµØ§Ø¯ÙÛŒ
          KEY_PASSWORD=$(openssl rand -base64 12)
          STORE_PASSWORD=$(openssl rand -base64 12)
          
          # Ø§ÛŒØ¬Ø§Ø¯ keystore Ø¬Ø¯ÛŒØ¯
          keytool -genkeypair -dname "CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown" \
            -alias my-key-alias \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -keystore keystore.jks \
            -storepass "$STORE_PASSWORD" \
            -keypass "$KEY_PASSWORD"
          
          # Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø³ÙˆØ±Ø¯Ù‡Ø§ Ø¯Ø± Ù…Ø­ÛŒØ·
          echo "KEYSTORE_PASSWORD=$STORE_PASSWORD" >> $GITHUB_ENV
          echo "KEY_PASSWORD=$KEY_PASSWORD" >> $GITHUB_ENV
          echo "KEY_ALIAS=my-key-alias" >> $GITHUB_ENV

      - name: ğŸ”‘ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ keystore Ø³ÙØ§Ø±Ø´ÛŒ
        if: github.event.inputs.signingMethod == 'custom' && secrets.KEYSTORE_BASE64 != ''
        run: |
          cd workspace
          echo "ğŸ”‘ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ keystore Ø³ÙØ§Ø±Ø´ÛŒ..."
          
          # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ secrets Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
          if [ -z "${{ secrets.KEYSTORE_BASE64 }}" ] || [ -z "${{ secrets.KEYSTORE_PASSWORD }}" ] || [ -z "${{ secrets.ALIAS_NAME }}" ]; then
            echo "âŒ Ù„Ø·ÙØ§Ù‹ KEYSTORE_BASE64ØŒ KEYSTORE_PASSWORD Ùˆ ALIAS_NAME Ø±Ø§ Ø¯Ø± GitHub Secrets ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯"
            exit 1
          fi
          
          # Ø¯ÛŒÚ©Ø¯ Ú©Ø±Ø¯Ù† keystore
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore.jks
          
          # Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ù…Ø­ÛŒØ·
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.ALIAS_NAME }}" >> $GITHUB_ENV

      - name: ğŸ—ï¸ Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯
        run: |
          cd workspace
          echo "ğŸ—ï¸ Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ø¨Ø§ Bubblewrap..."
          
          # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ bubblewrap.json
          cat > bubblewrap.json << EOF
          {
            "appVersionName": "${{ github.event.inputs.versionName }}",
            "appVersion": ${{ github.event.inputs.versionCode }},
            "backgroundColor": "${{ github.event.inputs.backgroundColor }}",
            "enableNotifications": ${{ github.event.inputs.enableNotifications }},
            "enableSiteSettingsShortcut": true,
            "fetchTimeout": 30000,
            "host": "${{ github.event.inputs.siteUrl | replace: 'https://', '' | replace: '/', '' }}",
            "iconUrl": "./icon-512.png",
            "launcherName": "${{ github.event.inputs.appName }}",
            "name": "${{ github.event.inputs.appName }}",
            "packageId": "${{ github.event.inputs.packageId }}",
            "signingKey": {
              "alias": "${{ env.KEY_ALIAS }}",
              "file": "keystore.jks",
              "keyPass": "${{ env.KEY_PASSWORD }}",
              "storePass": "${{ env.KEYSTORE_PASSWORD }}"
            },
            "shortcuts": [],
            "schemes": ["https"],
            "signing": {
              "keystore": "keystore.jks"
            },
            "splashScreenFadeOutDuration": 300,
            "startUrl": "${{ github.event.inputs.siteUrl }}",
            "themeColor": "${{ github.event.inputs.themeColor }}",
            "display": "${{ github.event.inputs.displayMode }}",
            "additionalTrustedOrigins": [],
            "webManifestUrl": "./manifest.json",
            "enableLocation": ${{ github.event.inputs.enableLocation }},
            "enableFullscreen": ${{ github.event.inputs.enableFullscreen }},
            "enableOrientationLock": ${{ github.event.inputs.enableOrientationLock }}
          }
EOF
          
          # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„ keystore Ø¨Ø±Ø§ÛŒ Ø±ÙˆØ´ Ø§Ù…Ø¶Ø§
          if [ "${{ github.event.inputs.signingMethod }}" != "none" ] && [ ! -f keystore.jks ]; then
            echo "âŒ ÙØ§ÛŒÙ„ keystore ÛŒØ§ÙØª Ù†Ø´Ø¯"
            exit 1
          fi
          
          # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÙˆØ± init
          bubblewrap init --manifestFile=manifest.json
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯Ù†
          if [ $? -ne 0 ]; then
            echo "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯"
            exit 1
          fi

      - name: ğŸ–¼ï¸ Ø§ÙØ²ÙˆØ¯Ù† ØªØµÙˆÛŒØ± Ø§Ø³Ù¾Ù„Ø´ Ø¨Ù‡ Ù…Ù†Ø§Ø¨Ø¹
        run: |
          cd workspace
          echo "ğŸ–¼ï¸ Ø§ÙØ²ÙˆØ¯Ù† ØªØµÙˆÛŒØ± Ø§Ø³Ù¾Ù„Ø´ Ø¨Ù‡ Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯..."
          
          # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
          mkdir -p app/src/main/res/drawable-xxxhdpi
          mkdir -p app/src/main/res/drawable-xxhdpi
          mkdir -p app/src/main/res/drawable-xhdpi
          mkdir -p app/src/main/res/drawable-hdpi
          mkdir -p app/src/main/res/drawable-mdpi
          
          # Ú©Ù¾ÛŒ ØªØµÙˆÛŒØ± Ø§Ø³Ù¾Ù„Ø´
          cp splash.png app/src/main/res/drawable-xxxhdpi/splash.png
          convert splash.png -resize 768x375 app/src/main/res/drawable-xxhdpi/splash.png
          convert splash.png -resize 512x250 app/src/main/res/drawable-xhdpi/splash.png
          convert splash.png -resize 384x187 app/src/main/res/drawable-hdpi/splash.png
          convert splash.png -resize 256x125 app/src/main/res/drawable-mdpi/splash.png

      - name: âš™ï¸ Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ APK
        run: |
          cd workspace
          echo "âš™ï¸ Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ APK..."
          
          # Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ APK
          bubblewrap build --skipPwaValidation
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯Ù† Ø³Ø§Ø®Øª
          if [ ! -f app-release-signed.apk ]; then
            echo "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ APK"
            ls -la
            exit 1
          fi
          
          echo "âœ… Ø³Ø§Ø®Øª APK Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯"

      - name: ğŸ“¦ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ
        run: |
          cd workspace
          echo "ğŸ“¦ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ..."
          
          # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ ØªÙˆØ¶ÛŒØ­Ø§Øª
          cat > README.txt << EOF
          # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†
          Ù†Ø§Ù…: ${{ github.event.inputs.appName }}
          Ø´Ù†Ø§Ø³Ù‡ Ù¾Ú©ÛŒØ¬: ${{ github.event.inputs.packageId }}
          Ù†Ø³Ø®Ù‡: ${{ github.event.inputs.versionName }} (${{ github.event.inputs.versionCode }})
          Ø¢Ø¯Ø±Ø³ Ø³Ø§ÛŒØª: ${{ github.event.inputs.siteUrl }}
          
          # Ù†Ø­ÙˆÙ‡ Ù†ØµØ¨
          1. ÙØ§ÛŒÙ„ APK Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯
          2. Ø±ÙˆÛŒ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ÛŒ Ø®ÙˆØ¯ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯
          3. Ø¨Ø±Ø§ÛŒ Ù†ØµØ¨ Ø§Ø² "Ù†ØµØ¨ Ø§Ø² Ù…Ù†Ø§Ø¨Ø¹ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡" Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
          
          # ØªÙˆØ¬Ù‡
          Ø§ÛŒÙ† Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† ÛŒÚ© Progressive Web App (PWA) Ø§Ø³Øª Ùˆ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù†ØµØ¨ Ù†Ø¯Ø§Ø±Ø¯.
          Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù…Ø±ÙˆØ±Ú¯Ø± Ø¨Ù‡ Ø¢Ø¯Ø±Ø³ Ø²ÛŒØ± Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯:
          ${{ github.event.inputs.siteUrl }}
          
          # Ø§Ù…Ø¶Ø§
          Ø±ÙˆØ´ Ø§Ù…Ø¶Ø§: ${{ github.event.inputs.signingMethod }}
          EOF
          
          # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ QR Code
          curl -o qrcode.png "https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=${{ github.event.inputs.siteUrl }}&bgcolor=ffffff&color=${{ github.event.inputs.themeColor | replace: '#', '' }}"

      - name: ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ
        uses: actions/upload-artifact@v3
        with:
          name: ${{ github.event.inputs.appName }}-apk-${{ github.event.inputs.versionName }}
          path: |
            workspace/app-release-signed.apk
            workspace/README.txt
            workspace/qrcode.png
            workspace/manifest.json
            workspace/index.html
            workspace/service-worker.js
            workspace/icon-512.png
            workspace/icon-192.png
            workspace/splash.png
          retention-days: 14

      - name: ğŸ“¢ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ù†ØªÛŒØ¬Ù‡
        if: always()
        run: |
          echo "ğŸ‰ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø³Ø§Ø®Øª APK Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯"
          echo "Ù†Ø§Ù… Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†: ${{ github.event.inputs.appName }}"
          echo "Ø´Ù†Ø§Ø³Ù‡ Ù¾Ú©ÛŒØ¬: ${{ github.event.inputs.packageId }}"
          echo "Ø¢Ø¯Ø±Ø³ Ø³Ø§ÛŒØª: ${{ github.event.inputs.siteUrl }}"
          echo "Ù†Ø³Ø®Ù‡: ${{ github.event.inputs.versionName }} (${{ github.event.inputs.versionCode }})"
          echo "Ø±ÙˆØ´ Ø§Ù…Ø¶Ø§: ${{ github.event.inputs.signingMethod }}"
          
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Ø³Ø§Ø®Øª APK Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯"
            echo "ÙØ§ÛŒÙ„ APK Ø¯Ø± Ø¨Ø®Ø´ Artifacts Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª"
            echo "Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ØŒ Ø¨Ù‡ Ø¨Ø®Ø´ Artifacts Ø¯Ø± ØµÙØ­Ù‡ Ø§ÛŒÙ† workflow Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯"
          else
            echo "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ APK"
            echo "Ù„Ø·ÙØ§Ù‹ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯"
          fi
          
          echo "â„¹ï¸ ØªÙˆØ¬Ù‡: Ø§Ú¯Ø± Ø§Ø² Ø±ÙˆØ´ Ø§Ù…Ø¶Ø§ 'bubblewrap' Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ø±Ø¯ÛŒØ¯ØŒ"
          echo "Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø¶Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ ÛŒØ§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ù…Ø­ÛŒØ· ØªÙˆÙ„ÛŒØ¯ØŒ"
          echo "Ù„Ø·ÙØ§Ù‹ Ø§Ø² keystore Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡ Ø¯Ø± Ù…Ø­ÛŒØ· ÙØ¹Ù„ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯."
